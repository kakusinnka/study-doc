# 最佳实践
创建一个新的 DAG 分为两步：1, 编写 Python 代码来创建 DAG 对象，2, 测试代码是否符合我们的期望。本教程将向您介绍这两个步骤的最佳实践。
## 编写 DAG
### 创建自定义运算符/挂钩
请按照我们的[自定义操作员](https://airflow.apache.org/docs/apache-airflow/2.2.5/howto/custom-operator.html#custom-operator)指南进行操作。
### 创建任务
* 您应该将 Airflow 中的任务等同于数据库中的事务。这意味着你永远不应该从你的任务中产生不完整的结果。
* 如果失败，Airflow 可以重试任务。因此，任务应该在每次重新运行时产生相同的结果。
### 删除任务
从 DAG 中删除任务时要小心。您将无法在图形视图、树视图等中看到任务，这使得从 Web 服务器检查该任务的日志变得困难。如果不需要，请创建一个新的 DAG。
### 沟通
使用 XCom 在任务之间传递小消息，在任务之间传递较大数据的一种好方法是使用远程存储，
### 顶级 Python 代码
影响 DAG 加载时间的重要因素之一，可能被 Python 开发人员忽视的是，顶级导入可能会花费惊人的大量时间，并且它们会产生大量开销，所以应该避免编写不需要的顶级代码。
### 动态 DAG 生成
避免在顶层代码进行过多处理，基本上可以通过以下方式之一进行配置：
* 通过环境变量：如果你想使用变量来配置你的代码，你应该总是在你的顶级代码中使用环境变量而不是 Airflow Variables。
* 使用嵌入的元数据生成 Python 代码：您可以在外部生成可导入常量的 Python 代码用来包含元数据。
* 具有来自结构化数据文件的外部配置的动态 DAG：如果您需要使用更复杂的元数据来准备您的 DAG 结构，并且您更愿意将数据保存为结构化的非 Python 格式，您应该将数据推送到 DAG 文件夹，
### 气流变量
您应该避免在 DAG 的顶级 Python 代码中使用 Airflow 变量。
### 更改后触发 DAG
简述了更改 DAG 文件后, 系统是如何反应更改的。以及加快反应速度的几个可配置值。
### 具有触发规则的观察者模式示例
观察者模式的任务正在“观察”其他任务的状态。它的主要目的是在任何其他任务失败时使 DAG 运行失败。
## 降低 DAG 复杂性
* 使您的 DAG 加载速度更快。
* 使您的 DAG 生成更简单的结构。
* 减少每个文件的 DAG 数量。
## 测试 DAG
### DAG 加载器测试
```
python your-dag-file.py
```
```
time python airflow/example_dags/example_python_operator.py
结果：
real    0m0.699s
user    0m0.590s
sys     0m0.108s
```
重要的指标是 real 它告诉您处理 DAG 花费了多长时间。
```
time python -c ''
结果：
real    0m0.073s
user    0m0.037s
sys     0m0.039s
```
获取解释器初始加载时间  
DAG 的实际解析时间约为：real - 解释器初始加载时间
### 单元测试
单元测试确保您的 DAG 中没有不正确的代码。您可以为您的任务和 DAG 编写单元测试。
### 自查
您还可以在 DAG 中实施检查以确保任务产生预期的结果。
### 暂存环境
如果可能，请保留一个暂存环境以在部署到生产环境之前测试完整的 DAG 运行。
模拟变量和连接