# 处理身份验证和授权
本模块涵盖在 Google Cloud 上的应用程序中处理身份验证和授权。

## 课程介绍
在应用程序中从头开始实现用户身份验证和授权可能有些令人生畏。借助 Cloud Identity and Access Management（简称 Cloud IAM）和 Identity Platform 身份验证，您现在无需承担构建此类系统的负担。

在处理身份验证和授权模块中，您将学习如何创建 IAM 成员、指定他们有权访问哪些资源以及他们可以对这些资源执行哪些操作。

您将了解如何使用服务帐号来允许应用进行身份验证并授权自己调用 Google Cloud API。我们将讨论如何使用身份感知代理来控制对应用程序的访问。

借助 Firebase SDK，您可以非常轻松地实现联合身份管理。您将了解如何使用 Firebase SDK 根据存储在 Identity Platform（Google Cloud 的企业级身份和访问管理平台）中的凭据验证用户。

## 课程信息
略

## IAM 概念
### 云身份和访问管理
借助 Cloud IAM，您可以通过定义谁（成员）对哪个资源拥有哪些访问权限（角色）来管理访问控制。您可以使用最低权限的安全原则授予对 Google Cloud 资源的更精细访问权限，即仅授予对必要资源的访问权限。

### 指定谁有权访问 IAM 成员
您可以指定谁有权访问 IAM 成员的资源。会员可以属于以下类型：Google 帐号、服务帐号、Google 群组、Google Workspace 网域或 Cloud Identity 网域。

* Google Cloud 帐号代表开发者、管理员或与 Google Cloud 互动的人员。与 Google 帐户关联的电子邮件地址（例如 gmail.com 地址）可以是身份。
* 服务帐户属于应用程序，而不是属于单个最终用户。
* Google 群组是 Google 帐号和服务帐号的命名集合。每个组都有一个与该组关联的唯一电子邮件地址。Google 网上论坛是将访问政策应用于一组用户的便捷方式。Google 网上论坛没有登录凭据，因此您无法使用它们来建立身份以发出访问资源的请求。
* Google Workspace 网域代表单位中所有成员的虚拟群组。Google Workspace 客户可以将其电子邮件帐号与互联网域名相关联。执行此操作时，每个电子邮件帐户都采用 username@yourdomain.com 形式。您可以使用与 Google Workspace 帐号关联的任何互联网域名来指定身份。与组一样，域不能用于建立身份，但它们可以方便地进行权限管理。
* Cloud Identity 网域代表单位中所有成员的虚拟群组，但不提供对 Google Workspace 应用和功能的访问权限。

### 指定成员有权访问的资源
您可以向用户授予对 Google Cloud 资源的访问权限。资源的一些示例包括项目、Compute Engine 实例和 Cloud Storage 存储分区。

### 指定允许对资源执行哪些操作
权限决定了允许对资源执行哪些操作。

### 使用角色分配权限：基本、预定义或自定义
角色是权限的集合。不能直接向用户分配权限;相反，您授予他们一个角色。当您向用户授予角色时，您将授予他们该角色包含的所有权限。使用 Cloud IAM 时，Cloud API 方法要求发出 API 请求的身份具有使用资源的相应权限。您可以通过向用户、组或服务帐户授予角色来授予权限。

有三种类型的角色：基本角色、预定义角色和自定义角色。

* 在项目级别应用基本角色：可以使用 Cloud Console、API 和 gcloud 命令行工具在项目级别应用基本角色。
* 应用预定义角色，实现对 Google Cloud 资源的精细访问：Cloud IAM 提供了预定义的角色，这些角色可以精细访问特定的 Google Cloud 资源，并防止对其他资源进行不必要的访问。
* IAM 自定义角色允许您定义一组精确的权限：这是自定义角色所允许的。许多公司使用“最小特权”模型，在这种模型中，组织中的每个人都拥有完成其工作所需的最低权限。其次，自定义角色只能在项目或组织级别使用。它们不能在文件夹级别使用。

### 使用策略定义谁拥有哪种类型的访问权限
策略附加到资源，用于在访问该资源时强制实施访问控制。  
![](../images/iam-policy-001.png)

Cloud IAM 策略由 Policy 对象表示。策略由绑定列表组成。绑定将成员列表绑定到角色。  
![](../images/iam-policy-example.png)

### 在调用 Google APis 时，使用服务帐号对应用进行身份验证
服务帐户属于应用程序或 VM 实例，而不是单个用户。您的应用使用它们来调用 Google API 或服务，以便用户不直接参与身份验证过程。每个服务帐户都由其唯一的电子邮件地址标识。服务帐号与一个密钥对相关联，最多可以关联 10 个密钥对，以便于密钥轮换，轮换由 Google 管理，每天完成一次。服务账户启用身份验证和授权，因为您可以将特定的 IAM 角色分配给服务账户。

### 使用外部密钥在 Google Cloud 外部使用
您可以创建要在 Google Cloud 外部使用的外部密钥。它们要求您管理私钥的安全性并执行密钥轮换等管理操作。外部密钥可通过 Cloud IAM API、gcloud 工具和 Cloud Console 进行管理。

### 您可以在一个项目中定义多个服务帐户
![](../images/many-service-account.png)  
您可以在一个项目中定义许多非默认服务帐户。该图显示了一个用例，通过让每个微服务由其自己的服务帐户表示，在单个云项目中管理多个微服务。  
粒度是通过指定允许哪些服务帐户调用哪些其他服务来使用的。

### 在应用程序中使用服务帐户的步骤
![](../images/service-account-for-app.png)  
要在应用程序中使用服务帐户，请首先通过控制台创建服务帐户。然后，生成并下载凭证文件，然后可以使用下载的凭证路径设置环境变量。该示例显示了在 Linux/OS X 和 Windows 中设置环境变量的命令。然后，您可以在代码中发出经过身份验证的 API 请求。示例代码是用 Python 编写的，它显示如果在构造客户端时未显式指定凭据，则客户端库将在环境中查找凭据。

### 使用应用程序默认凭据 （ADC） 在应用程序之间进行身份验证
![](../images/ADC.png)  
Google Cloud 客户端库使用应用默认凭据 ADC 来查找应用的凭据。按以下顺序检查凭据： ADC 将检查GOOGLE_APPLICATION_CREDENTIALS环境变量。如果设置了环境变量，ADC 将使用该变量指向的服务帐户文件。如果未设置环境变量，ADC 将使用 Compute Engine、Google Kubernetes Engine （GKE）、App Engine 和 Cloud Functions 提供的默认服务帐号，前提是您的应用在这些服务上运行。如果找不到环境变量和默认服务帐户，则会发生错误。

## IAM 最佳实践
### 遵循最小权限原则
### 定期轮换服务帐户密钥并实施流程
### 不要将服务帐户密钥签入源代码
### 使用 Cloud Audit Logs 定期审核对 IAM 政策的更改，并将日志导出到 Cloud Storage
### 设置组织级 IAM 策略以授予对组织中所有项目的访问权限，以及尽可能将角色授予 Google 群组，而不是单个用户

## OAuth2.0、IAP 和 Firebase 身份验证
### 使用 0Auth 2.0 代表用户访问资源
![](../images/use-OAuth2.0.png)  
您可以使用 OAuth 2.0 协议代表用户访问资源。应用程序将请求访问资源，系统将提示用户同意，如果提供同意，则应用程序可以从授权服务器请求凭据。然后，应用程序可以使用这些凭据代表用户访问资源。

### 身份感知代理 （IAP）
* 控制对在 Google Cloud 上运行的云应用的访问。
* 验证用户的身份。
* 确定该用户是否应该被允许访问应用程序。

IAP允许您为通过HTTPS访问的应用程序建立中央授权层。IAP 允许您采用应用程序级访问控制模型，而不是依赖网络级防火墙。

![](../images/how-iap-works.png)  
受 IAP 保护的应用和资源只能由具有正确 Cloud IAM 角色的组中的用户通过代理访问。当您通过 IAP 授予用户访问应用程序或资源的权限时，他们将受到使用中的产品实施的细粒度访问控制，而无需 VPN。当用户尝试访问受 IAP 保护的资源时，IAP 会执行身份验证和授权检查。

使用 IAP 时请遵循以下注意事项
* 配置防火墙和负载均衡器，以防止不是来自服务基础结构的流量。
* 使用已签名的标头或 App Engine 标准环境用户 API。

### Identity Platform 提供身份验证即服务
Identity Platform 是一个客户身份和访问管理平台，用于向应用程序添加身份和访问管理。它以服务形式提供身份验证，开发人员可以通过一组 SDK 进行访问。

### Identity Platform 和 Firebase 身份验证之间的差异
Identity Platform 和 Firebase Authentication 提供类似的功能。两者都允许你通过提供后端服务、SDK 和 UI 库来轻松将用户登录到你的应用。

但是，Identity Platform 提供了专为企业客户设计的附加功能，例如 OpenID Connect 和 SAML 身份验证、多租户支持、身份感知代理集成以及 99.95% 的正常运行时间 SLA。

## 实验室：向您的应用程序添加用户身份验证

## 应用程序开发 - 向您的应用程序添加用户身份验证：Java 

## 练习测验

## 处理身份验证和授权测验

## 总结
您可以通过创建具有适当权限的 IAM 成员来控制用户对应用程序中资源的访问。应用程序对 Google Cloud API 的访问由服务帐号控制。您的应用会采用服务帐号的身份来调用 Google Cloud API。您可以创建一个或多个服务帐户来限制对应用程序中不同资源的访问。

身份感知代理（简称 IAP）使您能够控制对应用程序的访问。它验证用户的身份，并检查是否应允许该用户访问应用程序。最终用户只需使用可通过 Internet 访问的 URL 即可访问受 IAP 保护的应用程序。不再有VPN！

借助 Identity Platform，您可以轻松地将广泛采用、用户友好且可自定义的身份验证服务添加到您的 Web 和移动应用程序中，以便您可以专注于构建您的应用程序或服务。

# 使用 Pub/Sub 集成应用程序的组件

# 为您的应用程序添加智能

# 使用云函数进行事件驱动处理

# 使用 Cloud Endpoints 管理 API

# 