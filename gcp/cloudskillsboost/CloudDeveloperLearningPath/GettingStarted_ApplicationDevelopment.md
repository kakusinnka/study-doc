# 欢迎 - 使用 Google Cloud 开发应用程序
本模块介绍课程系列和课程结构。

## 欢迎来到课程系列
此路径专为负责设计、开发、部署和维护云中应用程序的 IT 专业人员（例如云开发人员和云 DevOps 工程师）而设计。

您将首先学习一些应用程序开发的最佳实践。然后，您将了解如何实施使用 Google Cloud 服务进行数据存储、应用程序组件之间的集成、安全性和可靠性的应用程序。如果您不确定是否在 Compute Engine、Google Kubernetes Engine、Cloud Run 中运行应用程序，或其他环境，我们有正确的信息来帮助您做出选择。

## 系列课程涵盖的主题
使用 Google Cloud 开发应用程序分为三门课程。  
1. 应用程序开发入门。
2. 保护和集成应用程序组件
3. 应用程序部署、调试和性能。

## 欢迎来到课程
略

## 课程信息
略

# 应用程序开发的最佳实践
本模块介绍应用程序开发的最佳实践。

## 松耦合微服务和 API 网关
### 云中运行的应用程序
* 全球影响力：您的应用程序应该能够响应并可供世界各地的用户访问。
* 可扩展性和高可用性：您的应用程序应该能够可靠地处理高流量。应用程序架构应利用底层云平台的功能来弹性扩展以响应负载的变化。
* 安全性：您的应用程序和底层基础设施应该实施安全最佳实践。根据使用案例，出于安全和合规性原因，您可能需要隔离特定区域中的用户数据。

### 管理应用程序的代码和环境
![管理应用程序的代码和环境](../images/manage-code-env.png)  
* 将应用程序的代码存储在版本控制系统（例如 Git 或 Subversion）的代码存储库中。这将使您能够跟踪源代码的更改并设置持续集成和交付的系统。
* 不要在代码存储库中存储外部依赖项，例如 JAR 文件或外部包。相反，根据您的应用程序平台，显式声明您的依赖项及其版本，并使用依赖项管理器安装它们。例如，对于 Node.js 应用程序，您可以在 package.json 文件中声明应用程序依赖项，然后使用 npm install 命令安装它们。
* 将应用程序的配置设置与代码分开。不要将配置设置存储为源代码中的常量。相反，请将配置设置指定为环境变量。这使您能够轻松修改开发、测试和生产环境之间的设置。

### 考虑实施微服务
不要实现单一应用程序，而是考虑将应用程序实现或重构为一组微服务。服务边界匹配业务边界，代码库是模块化的，每个服务都可以独立更新、部署和扩展

### 执行异步操作
远程操作的响应时间可能无法预测，并且可能使您的应用程序看起来很慢。尽量减少用户线程中的操作。异步执行后端操作。

尽可能使用事件驱动的处理。例如，如果您的应用程序处理用户上传的图片，您可以使用 Cloud Storage 存储分区来存储上传的图片。然后，您可以实现一个云函数，每当上传新图像时就会触发该函数。云功能处理图像并将结果上传到不同的云存储位置。

### 松耦合设计
设计应用程序组件，以便它们在运行时松散耦合。紧密耦合的组件可能会降低应用程序对故障、流量峰值和服务更改的弹性。

中间组件（如消息队列）可用于实现松耦合、执行异步处理以及在流量激增时缓冲请求。您可以将 Pub/Sub 主题用作消息队列。发布者可以向主题发布消息，订阅者可以订阅来自该主题的消息。

在 HTTP API 有效负载的上下文中，HTTP API 的使用者应与 API 的发布者松散绑定。

### 实现无状态组件以实现可伸缩性
实现应用程序组件，以便它们不会在内部存储状态或访问共享状态。访问共享状态是可伸缩性的常见瓶颈。设计每个应用程序组件，使其仅专注于计算任务。此方法使您能够使用 Worker 模式来添加或删除组件的其他实例，以实现可伸缩性。应用程序组件应快速启动以实现高效扩展，并在收到终止信号时正常关闭。

### 缓存内容
缓存内容可以提高应用程序性能并降低网络延迟。

### 实施 API 网关，使后端功能可供使用者应用程序使用
![API 网关](../images/API-gateways.png)  
* 您可以使用 Cloud Endpoints 根据 OpenAPI 规范开发、部署、保护和监控 API。
* 使用 Apigee API 平台，您可以为传统后端设计、保护、分析和扩展 API。

## 安全性、可靠性和迁移
### 使用联合身份管理
将用户身份验证委托给外部身份提供商，例如 Google、Facebook、Twitter 或 GitHub。这将最大程度地减少用户管理的工作量。使用联合身份管理，您无需实施、保护和扩展专有解决方案来对用户进行身份验证。

### 实施运行状况检查终结点
请务必监视应用程序和服务的状态，以确保它们始终可用并以最佳方式执行。监控数据可用于在系统开始出现故障时立即自动向运营团队发出警报。然后，运营团队可以及时诊断和解决问题。

### 设置日志记录并监视应用程序的性能
将日志视为事件流。日志构成一个连续的事件流，只要应用程序正在运行，这些事件就会不断发生。不要管理应用程序中的日志文件。相反，写入事件流（如 stdout），并让底层基础结构整理所有事件，以便以后进行分析和存储。使用此方法，您可以设置基于日志的指标，并跨应用程序中的不同服务跟踪请求。

借助 Google Cloud 的运维套件，您可以调试应用、设置错误报告、设置基于日志记录和日志的指标、跨服务跟踪请求，以及监控在多云环境中运行的应用。

### 优雅地处理暂时性和长期性错误
在访问分布式系统中的服务和资源时，应用程序需要能够灵活应对临时和长期的错误。  
由于暂时性网络错误，资源有时会变得不可用。在这种情况下，应用程序应实现具有指数退避的重试逻辑，如果错误仍然存在，则正常失败。云客户端库会自动重试失败的请求。  
当错误持续时间更长时，应用程序不应浪费 CPU 周期尝试重试请求。在这种情况下，应用程序应实现断路器并正常处理故障。  
对于传播回用户的错误，请考虑正常降级应用程序，而不是显式显示错误消息。例如，如果推荐引擎已关闭，请考虑隐藏页面上的产品推荐区域，而不是在每次显示页面时都显示错误消息。

### 考虑数据主权和合规性要求
一些地区和行业部门对数据保护和消费者隐私有严格的合规要求。

### 执行高可用性测试并制定灾难恢复计划
除了执行功能和性能测试外，还要执行高可用性测试。此类测试将使您能够制定可靠的灾难恢复计划，并定期执行灾难恢复练习。

### 实施持续集成和持续交付管道
通过自动化实施强大的 DevOps 模型，以实现持续集成和交付 （CI/CD）。自动化可帮助您提高发布速度和可靠性。借助强大的 CI/CD 管道，您可以以增量方式测试和推出更改，而不是通过多个更改进行大规模发布。此方法使你能够降低回归风险，快速调试问题，并在必要时回滚到上一个稳定版本。

在持续集成系统中，开发人员将代码提交到代码存储库（如 Git）中。构建系统（如 Jenkins）会自动检测对存储库的提交、触发构建并运行单元测试。生成系统为所有必需的运行时环境生成部署工件。

在持续交付系统中，部署系统（如 Spinnaker）会自动触发将构建部署到测试环境。您可以自动执行集成、安全和性能测试，然后将成功的构建部署到生产环境。将内部版本部署到生产环境时，请考虑执行金丝雀测试或蓝/绿部署，以确保任何意外问题都不会影响大量用户。

### 使用扼杀者模式重新构建应用程序
在重新构建和迁移大型应用程序时，请考虑使用 Strangler 模式。在迁移的早期阶段，您可能会将旧应用程序的较小组件替换为较新的应用程序组件或服务。您可以逐步将原始应用程序的更多功能替换为新服务。

## 练习测验：应用程序开发的最佳实践
略

## 最终测验：应用程序开发的最佳实践
略

# Google 云开发入门
本模块介绍了用于托管应用程序的不同 Google Cloud 平台。

## Google Cloud 开发入门
在本模块中，您将学习如何为您的应用和脚本访问这些服务。您将了解 Cloud API 和 Google Cloud SDK，它们允许您以编程方式将这些功能包含在您的应用中。 云客户端库通过使用每种受支持语言的自然约定和样式来提供优化的开发人员体验。您还将了解 Cloud Code，这将帮助您在集成开发环境中开发 Google Cloud 应用。

### Cloud API 为 Google Cloud 服务提供编程接口
Cloud API 为 Google Cloud 服务提供编程接口。您可以通过调用相应的 Cloud API 在应用中使用 Google Cloud 资源或服务。

### 将 Google Cloud SDK 与 Google Cloud 结合使用
Google Cloud SDK 用于与 Google Cloud 产品和服务进行交互。  
* SDK 功能分为两类：命令行工具和特定于语言的云客户端库。
* 这些工具和库使用 Cloud API 与 Google Cloud 进行通信。

### 使用 Google Cloud CLI （gcloud CLI）
* 提供用于管理大多数 Google Cloud 服务的工具。
* 在命令行或自动脚本中使用。
* 工具包装了 Cloud API

#### 借助 gcloud CLI 工具，您可以在 Google Cloud 上执行最常见的任务
#### 使用命令行工具 gcloud storage 管理 Cloud Storage
#### bq 是 BigQuery 的命令行工具

### 云客户端库
* 比直接 API 调用更易于使用。
* 是从应用发出 Cloud API 请求的推荐方法。
* 提供优化的开发人员体验。
* 使用每种语言的自然惯例和风格。
* 从 gRPC API 获得性能优势。

### Cloud Shell
Cloud Shell 是一台免费的管理计算机，可通过 Google Cloud Console 进行基于浏览器的命令行访问。  
* 基于浏览器访问临时虚拟机
  * 5 GB的永久性磁盘存储
  * 预装了 Google Cloud SDK
* 对 Google Cloud Console 项目和资源的内置授权
* 内置代码编辑器

### 使用 Cloud Code 在您喜欢的 IDE 中开发云应用程序
* 借助 IDE 插件，可以更轻松地创建、部署和调试云原生应用程序。
* 适用于 VSCode、JetBrains IDE（包括 IntelliJ）和 Cloud Shell 编辑器。
* IDE 简化了常见的工作流程。
* 与 Secret Manager 集成以安全地存储敏感数据。
* 管理云 API 和云客户端库。

### 借助 Cloud Code for Kubernetes，您可以在 IDE 中开发 Kubernetes 应用
* 在本地集群或 Google Kubernetes Engine （GKE） 上运行和调试 Kubernetes 应用程序。
* 使用 Kubernetes Explorer 可视化和管理 Kubernetes 资源。
* YAML 创作帮助为 Kubernetes 配置文件提供自动完成和内联文档。

### Cloud Code 也适用于 Cloud Run
* 使用 Cloud Run Emulator 在本地运行服务并进行调试。
* 从 IDE 将应用部署到 Cloud Run。
* 使用 Cloud Run Explorer 管理 Cloud Run 服务。

### 将模拟器用于 Google Cloud 服务
* 使用 gcloud beta emulators 安装和管理模拟器。
* 从使用本地模拟器切换到使用 Google Cloud emulators 服务，而无需更改应用代码。
* 在不消耗项目资源的情况下开发应用程序。

## 练习测验：Google Cloud 开发入门
略

## Lab 搭建开发环境
略

## 应用程序开发 - 设置开发环境：Java
略

## 最终测验：Google Cloud 开发入门
略

## 模块复习
* Google Cloud API 为 Google Cloud 服务提供编程接口。
* 在脚本或命令行中使用时，Google Cloud SDK 提供了更简单的界面。
* 当您准备好编写应用程序时，请使用您选择的编程语言的 Cloud 客户端库来与 Google Cloud 服务交互。
* Cloud Shell 提供免费的虚拟机，可用于管理您的 Google Cloud 项目和资源。
* 使用 Cloud Code 在您最喜欢的 IDE 中开发应用程序。

# 数据存储选项概述
本模块介绍了 Google Cloud 中应用程序可用的各种数据存储选项。

## Cloud Storage, Datastore, Cloud Bigtable, Cloud SQL, and Cloud Spanner
### Cloud Storage
Cloud Storage 是面向开发人员和企业的统一对象存储，可让您提供、分析和归档数据。对象通过 HTTP 请求访问，包括用于检索部分数据的范围 GET。唯一的键是对象名称。有对象元数据，但对象本身被视为没有结构的字节。该系统的规模允许提供静态内容或接受用户上传的内容，如照片和视频。

Cloud Storage 专为可用性、持久性、可扩展性和一致性而构建。它是存储图像和视频、对象和 blob 以及任何非结构化数据的理想解决方案。

### Firestore
Firestore 是一个快速、完全托管的无服务器 NoSQL 文档数据库，专为自动扩展、高性能和易于应用程序开发而构建。

### Datastore
数据存储模式下的 Firestore（通常称为数据存储）是适用于应用程序的高度可扩展的 NoSQL 数据库。数据存储会自动处理分片和复制，为您提供一个高度可用且持久的数据库，该数据库可自动扩展以处理应用程序的负载。数据存储提供了无数的功能，例如 ACID 事务、类似 SQL 的查询、索引等等。数据存储可随数据无缝自动扩展，使应用程序在接收更多流量时保持高性能。

### Cloud Bigtable
Bigtable 是一种高性能的 NoSQL 数据库服务。这是一个稀疏填充的表，可以扩展到数十亿行和数千列。Bigtable 可以存储 TB 到 PB 的数据。Bigtable 专为在定义的键范围内快速键值查找和扫描而构建。它类似于电子表格，通过仅搜索第一列（键）中的值，您可以访问连续行中的任何一组列。对单个行的更新是原子的。由于 Bigtable 的快速查找和写入速度，它非常适合用户行为。

### Cloud SQL
Cloud SQL 是 Google Cloud 的关系数据库服务。这是一项托管服务，可让 Google 管理数据库的复制、故障转移和备份，以便您可以专注于 MySQL、PostgreSQL 或 SQL Server 兼容应用。借助 Cloud SQL，您可以轻松配置复制和备份，以保护您的数据。您可以将主实例复制到一个或多个只读副本。只读副本是主实例的副本，它几乎实时地反映对主实例的更改。您可以启用自动故障转移，使数据库具有高可用性。借助备份，您可以还原 Cloud SQL 实例，以恢复丢失的数据或从实例问题中恢复。您可以为包含需要防止丢失或损坏的数据的任何实例启用自动备份。

Cloud SQL Proxy 的工作原理是在本地环境中运行一个称为代理的本地客户端。应用程序使用数据库使用的标准数据库协议与代理进行通信。代理使用安全隧道与服务器上运行的配套进程进行通信。借助 Cloud SQL Proxy，您可以安全地访问 Cloud SQL 第二代实例，而无需允许 IP 地址或配置 SSL。代理使用 Cloud SQL API 向 Google Cloud 进行身份验证。您必须在使用代理之前启用 API，并且必须为代理提供有效的用户帐户。

### Cloud Spanner
Cloud Spanner 是 Google Cloud 的完全托管式关系数据库服务，提供强大的一致性和水平可扩展性。它专为任务关键型 OLTP 应用程序而设计。Cloud Spanner 提供自动同步复制以实现高可用性。Spanner 专为多区域复制而构建，提供业界最高的 SLA 之一：99.999%。

Spanner 非常适合具有关系、结构化和半结构化数据的应用程序，这些应用程序需要高可用性、强一致性和事务性读写。

与 Cloud SQL 不同，Spanner 要求每个表都有一个主键。另一个区别是 Spanner 还支持交错表，其中子行插入到与父行相邻的表中。这样可以提高在父级和子级之间完成联接时的查询性能。

## BigQuery, Microsoft SQL Server images on Google Cloud, and Firebase Storage Options
### BigQuery
BigQuery 是一种用于分析的低成本企业数据仓库。这是一项完全托管的服务，这意味着您无需担心数据仓库的管理。BigQuery 可以在几秒钟内扫描 TB 级数据，在几分钟内扫描 PB 级数据。

### 在 Google Cloud 上运行 Microsoft SQL Server
您可以在 Google Cloud 上运行 Microsoft SQL Server 部署。计算引擎虚拟机预装了 SQL Server，并自动包含来自 Microsoft 的许可。

支持的版本包括 SQL Server Standard、SQL Server Web 和 SQL Server Enterprise。

Google Cloud 上的 Microsoft SQL Server 不是像 Cloud SQL 或 Spanner 那样的托管服务。

### 适用于移动设备的存储选项
Firebase 是一个移动和 Web 应用开发平台，其中包含一些存储选项，可用于使用 Google Cloud 进行 Web 和移动开发。

Cloud Storage for Firebase 将用户生成的数据和文件存储到 Google Cloud Storage 中。适用于 Cloud Storage 的 Firebase SDK 为开发者提供了简单直观的身份验证。理想的用例包括从您的移动或 Web 应用程序保存用户生成的图像、图片、视频、对象和博客。

Firebase Realtime Database 允许您使用 Firebase 的 NoSQL 云数据库存储和同步数据。数据在所有客户端之间实时同步，以便在应用离线时保持可用。对于需要离线响应能力的移动和 Web 应用程序来说，它是一种理想的存储解决方案。Firebase 实时数据库是 Firebase 的原始数据库。对于大多数开始新项目的开发人员来说，现在建议使用 Firestore，而不是 Firebase Realtime Database。

Firebase 托管是一种快速、安全地为您的网络应用托管静态资源的方式。它是 URL 重写、原子发布管理和 Web 或移动应用程序的 Firebase 集成的理想选择。

### 缓存应用程序数据
您在 Google Cloud 上运行的应用可以通过利用 Redis 或 Memcached 来实现高水平的性能，而无需管理复杂的部署。Memorystore 支持这两个高度可扩展、可用且安全的开源缓存引擎，并且与每个引擎完全协议兼容。

Memorystore 是可扩展的 Web 应用程序、游戏和流处理的理想选择，在这些应用程序中，分布式内存数据存储允许快速、实时地处理数据。

作为一项完全托管的服务，预配、复制、故障转移和修补都是自动化的。您还可以使用 Cloud Monitoring 监控实例并设置警报。

通过使用 VPC 网络和私有 IP 地址，可以保护 Memorystore 免受 Internet 的侵害。Memorystore 还集成了 Cloud Identity and Access Management。

### 存储一目了然
![存储一目了然](../images/storage-glance-001.png)
![存储一目了然](../images/storage-glance-002.png)

## 演示：安全连接到 Cloud SQL 数据库
1. 创建 Cloud SQL 实例
2. 使用 gcloud sql 从 Cloud Shell 连接到 Cloud SQL
3. 创建 Compute Engine 实例
4. 使用 Cloud SQL 代理连接到 Cloud SQL

## 最终测验：数据存储选项
略

## 模块复习
* 将文件存储在 Cloud Storage 中。
* Cloud Datastore（一个 NoSQL 数据库）很容易上手，用它来存储结构化应用程序数据。
* Bigtable 是一个高性能宽列、NoSQL 数据库。Bigtable 非常适合处理大量平面数据，例如传感器读数以及来自物联网或 IoT 设备的数据。
* Cloud SQL 是 MySQL 和 PostgreSQL 的托管服务。您可以使用 Cloud SQL 代理轻松、安全地连接您的 Cloud SQL 实例。
* 如果您应用程序的关系数据将超出 Cloud SQL 中可以最佳处理的容量，或者您需要覆盖全球，请使用 Spanner。Spanner 是一种完全托管的关系数据库服务，提供强一致性和水平可扩展性。Spanner支持低延迟的全局自动同步复制。
* BigQuery 是一个完全托管的数据仓库解决方案。使用 BigQuery 进行分析工作负载。

# 使用数据存储的最佳实践
本模块涵盖使用数据存储的最佳实践。
## 数据存储概念和索引
假设您要存储应用程序数据。数据是结构化的或半结构化的，但不是关系型的。  
您希望快速启动并运行。但是，您希望确保所选的数据库选项具有高度可伸缩性，并满足应用程序的需求。  
数据存储是此用例的理想解决方案。数据存储可以从每秒零扩展到数百万个请求，而无需更改配置或向集群添加节点。  
在本模块“使用 Datastore 的最佳实践”中，您将了解有关数据对象的关键概念，例如种类、实体、键和属性。您将学习并应用与查询、内置索引和复合索引、插入和删除数据、事务和错误处理相关的最佳实践。

### 数据存储 = 数据存储模式下的 Firestore
* 与原始 Datastore 完全向后兼容，但使用 Firestore 改进的存储层。
* “数据存储”页面用于管理数据库。
* 一个项目只能具有 Firestore 本机模式数据库或数据存储模式数据库，但不能同时具有两者。
* 如何决定：
  * 在创建新的服务器应用程序时选择数据存储模式。
    * 自动扩展到每秒数百万次写入。
  * 为新的移动和 Web 应用程序或需要实时和离线功能时选择本机模式。
    * 自动扩展到数百万个并发客户端。

> 数据存储模式通常应用于服务器应用程序。本机模式应用于新的移动和 Web 应用，或者需要实时和离线功能时。

### 数据存储概念
![数据存储概念](../images/datastore-conceptes.png)

数据存储中的数据对象称为实体，它们由一个或多个属性组成。属性可以有一个或多个值。  
每个实体都有一个唯一标识它的键，该键由命名空间、实体的种类、标识符和可选的祖先路径组成。  
对一个或多个实体的操作称为事务，并且是原子的。

### 您可以指定实体的祖先
创建实体时，可以指定另一个实体作为其父实体。没有父级的实体是根实体。  
实体的父级、父级的父级等是实体的祖先。实体的子项、子项的子项等。是实体的后代。  
从根实体到特定实体的实体序列构成了祖先路径。

### 数据存储有两种类型的索引
内置索引: 
* 自动预定义: 每个属性的索引, 每个实体类型
* 适用于简单型查询

复合索引:
* 为索引实体的多个属性值编制索引
* 支持复杂查询
* 被定义在索引配置文件中

## 创建和删除复合索引
* 在名为 index.yaml 的配置文件中定义
* 要创建复合索引，请执行以下操作：
  * 在 index.yaml 中添加索引定义
  * 运行 gcloud datastore indexes create
* 要删除复合索引，请执行以下操作：
  * 从 index.yaml 删除不再需要的索引
  * 运行 gcloud datastore indexes cleanup

## 数据存储与关系数据库的比较
数据存储：
* 旨在自动扩展到非常大的数据集。
* 不支持联接操作、对多个属性进行不等式筛选，也不支持根据子查询结果对数据进行筛选。
* 不要求相同类型的实体具有一致的属性集。

## 演示探索云数据存储
1. 创建 App Engine 应用
2. 创建数据存储实体
3. 查询数据存储
4. 使用 GQL 查询数据存储

## 设计考虑因素和分片
使用 Cloud Datastore 设计应用时，请牢记以下注意事项。始终将 UTF-8 字符用于命名空间名称、种类名称、属性名称和自定义键名称。使用这些名称的非 UTF-8 字符可能会干扰 Cloud Datastore 的功能。

请勿在种类名称或自定义键名称中使用正斜杠 （/）。这些名称中的正斜杠可能会干扰将来的功能。

### 使用分片提高写入速率
分片将实体分解成更小的部分。数据存储将自动对实体进行分片，从而分发数据。

### 分片计数器，以避免与高写入发生争用
* 通过构建分片计数器来减少争用，将计数器分解为 N 个实体中的 N 个不同的计数器。
* 要递增，请随机选择一个分片并递增其计数器。
* 若要检索计数，请读取所有分片实体并对其各个计数求和。

### 使用复制读取密钥范围的一部分
如果需要以高于数据存储允许的速率读取密钥范围的一部分，则可以使用复制。使用此策略，您将存储同一实体的 N 个副本，从而允许比单个实体支持的读取速率高 N 倍。

### 设计应用程序操作时要记住的事项
* 使用批处理操作进行读取、写入和删除
* 回滚失败的事务
* 使用异步调用

## 复制、查询类型、事务和处理错误
### 根据需要使用查询类型
如果只需要从查询结果访问密钥，请使用仅密钥查询。同样，如果只需要访问实体中的特定属性，或者只需要访问查询筛选器中包含的属性，请使用投影查询。与检索整个实体相比，仅键查询和投影查询以更低的延迟和成本返回结果。

### 通过使用游标而不是偏移量来改善查询延迟
通常，应避免在查询中使用偏移量，而应使用游标。

### 数字 ID 作为键
对于使用数字 ID 的键：
* 不要使用负数。
* 不要使用值 0。
* 如果您希望手动为实体分配数字 ID，请使用 allocatelds（） 方法获取 ID 块。
* 避免单调递增值。

### 事务设计注意事项
事务是对一个或多个实体执行的一组数据存储操作。它们保证是原子的，这意味着要么应用事务中的所有操作，要么不应用任何操作。

> 最长事务时间为 270 秒，但如果 60 秒内没有活动，数据存储将终止事务。

### 设计应用程序以处理错误
当数据存储请求成功时，API 将返回 200 OK 状态代码，请求的数据位于响应正文中。  
失败会返回 4xx 或 5xx 状态代码，其中包含有关导致失败的错误的更具体信息。

## 演示从 Cloud Storage 批量加载 Datastore 数据
* 创建 Compute Engine 实例并安装运行 Apache Beam 所需的软件。
* 查看从 Datastore 读取的简单 Apache Beam 管道。
* 将数据文件上传到 Cloud Storage。
* 使用本地 Dataflow Runner 运行管道。查看数据存储中的输出。

## 应用程序开发 - 在云数据存储中存储应用程序数据：Java
* 在本实验中，您将执行以下任务：
* 预览应用程序
* 更新应用代码以集成 Cloud Datastore

## 练习测验：使用数据存储的最佳实践
略

## 最终测验：使用数据存储的最佳实践
略

## 模块复习
Cloud Datastore 是一种完全托管的 NoSQL 数据库服务，可用于存储结构化或半结构化应用程序数据。  
Cloud Datastore 中的数据对象称为实体。每个实体都是特定类型的。  
您可以指定实体之间的祖先路径关系来创建实体组。实体组的祖先查询为您提供高度一致的数据视图。通过创建实体组，您可以确保所有相关实体都可以在单个事务中更新。  
Cloud Datastore 自动为实体中的各个属性构建索引。要使用针对多个属性的过滤器启用更复杂的查询，您可以创建复合索引。  
Cloud Datastore 可以无缝扩展，且停机时间为零。

# 使用云存储的最佳实践
本模块涵盖使用云存储的最佳实践。

## 对桶和对象进行操作
Google Cloud Storage 概念：项目，桶 - 基本的 Cloud Storage 容器，对象 - 您存储在 Cloud Storage 中的各个数据片段。

### 存储类
* 标准存储最适合频繁访问或仅存储短时间的数据。使用标准存储类存储的数据没有最短持续时间。标准存储用例包括提供网站内容、流式传输视频、执行交互式工作负载以及提供支持移动和游戏应用程序的数据。
* 近线存储是一种低成本、高持久性的存储服务，用于存储不经常访问的数据。近线存储适用于数据备份、长尾多媒体内容和数据归档。
* Coldline Storage 是一种成本极低、持久性极强的存储服务，用于存储不常访问的数据。Coldline Storage 非常适合您计划每季度最多读取或修改一次的数据。
* 归档存储是用于数据归档、在线备份和灾难恢复的低成本、高持久性的存储服务。归档存储非常适合冷数据存储，例如出于法律或法规原因存储的数据。对于仅用于灾难恢复的数据，这也是一个不错的选择。

### 适用于所有存储类型的特性
* 无限存储，没有最小对象大小。
* 全球可访问性和全球存储位置。
* 低延迟（到第一个字节的时间通常为数十毫秒）。
* 高耐久性（99.9999999999%的年耐久性）。
* 如果数据存储在多区域或双区域中，则为异地冗余。
* Cloud Storage 功能、安全性、工具和 API 的统一体验。

### 操作具有很强的一致性
高度一致的操作意味着，当您在 Cloud Storage 中执行某项操作并收到成功响应时，该对象可以立即从 Google 提供服务的任何位置进行下载和元数据操作。  
Google Cloud Storage 中的以下操作具有很强的一致性：先写后读、元数据更新后读取、删除后读取、存储桶列表、对象列表和授予资源访问权限。

### 操作最终是一致的
以下操作最终是一致的：撤消对象的访问权限和访问可公开读取的缓存对象。

### 使用以下请求终结点
![](../images/gcs-used-endpoints.png)  
* 使用 XML API，可以使用列出的两个 URI，使用 JSON API，可以使用列出的 URI。这些 URI 支持安全套接字层 （SSL） 加密，因此可以使用 HTTP 或 HTTPS。如果您使用 OAuth 2.0 向 Cloud Storage API 进行身份验证，则应使用 HTTPS。
* CNAME 重定向是一种特殊的 DNS 记录，可让您使用自己网域中的 URI 访问 Cloud Storage 中的资源，而无需泄露 Cloud Storage URI。
* 您还可以使用经过身份验证的浏览器下载来访问资源，如果您已登录 Google 帐户并被授予读取数据的权限，则可以通过浏览器下载数据。经过身份验证的浏览器下载将基于 Cookie 的 Google 帐户身份验证与基于 Google 帐户的 ACL 结合使用。要使用基于 Cookie 的身份验证下载对象，必须使用以下 URI：https://storage.cloud.google.com//。仅支持 HTTPS。
* 您可以修改基于内容的负载平衡配置，以路由静态内容复制到 Cloud Storage 存储分区中。

### 复合对象和并行上传
您最多可以将 32 个现有对象组合成一个新对象，而无需传输其他对象数据。  
对象组合可用于并行上传对象：只需将数据划分为多个块，将每个块并行上传到不同的对象，编写最终对象，然后删除任何临时对象。

## 桶/对象操作和截断指数退避
### 设计应用程序以处理具有截断指数退避的网络故障
截断指数退避：
* 是网络应用程序的标准错误处理策略。
* 定期重试失败的请求，请求之间的延迟不断增加。
* 应用于返回 HTTP 5xx 和 429 响应代码的所有 Cloud Storage 请求。

## 演示在 Cloud Storage 中启用 CORS 配置
1. 创建 Compute Engine 实例
2. 安装必备软件
3. 下载并配置演示应用程序
4. 演示工作应用程序
5. 重新定位 data.json 文件并更新演示应用程序
6. 应用 CORS 配置

## 使用云存储的最佳实践（第1部分）
### 请遵循以下最佳命名做法
* 使用全局唯一的存储桶名称
* 如果您的应用程序需要大量存储桶，请使用 GUID 或等效项
* 符合标准的DNS命名约定

### 请遵循以下针对 Cloud Storage 流量的最佳做法
请考虑每秒操作次数、带宽（在什么时间范围内发送的数据量）和缓存控制。如果在对象上指定 Cache-Control 元数据，则热对象或频繁访问对象的读取延迟将降低。

### 考虑数据的位置和可用性
将数据存储在最接近应用程序用户的区域中，并在选择数据位置时考虑特定于区域的合规性要求。对于分析工作负载，与多区域或双区域相比，将数据存储在区域存储桶中，以降低网络费用并提高性能。

### 考虑数据的特征
略

### 使用以下选项保护存储桶
* 使用 Identity and Access Management （IAM） 权限授予：访问存储桶，批量访问存储桶的对象。
* 使用访问控制列表 （ACL） 授予：用户对单个存储桶或对象的读取或写入访问权限。当需要对单个对象进行精细控制时进行访问。
* 签名 URL（查询字符串身份验证）：通过生成的 URL 提供对对象的限时读取或写入访问权限。可以使用 gcloud 存储或以编程方式创建。
* 使用已签名的保单文档可以：指定可以上传到存储桶的内容。控制大小、内容类型和其他上传特征。
* Firebase 安全规则提供：使用适用于 Cloud Storage 的 Firebase SDK 对移动应用和 Web 应用进行基于属性的精细访问控制。

### 请考虑以下其他安全最佳做法
* 使用 TLS （HTTPS） 传输数据。
* 使用验证服务器证书的 HTTPS 库。
* 吊销不再需要访问数据的应用程序的身份验证凭据。
* 安全地存储凭据。
* 使用组而不是大量用户。
* 存储桶和对象 ACL 彼此独立。
* 避免使存储桶可公开读取或可公开写入。

### 考虑保留策略和保留策略锁定
* 向存储桶添加保留策略以指定保留期。
  * 如果不存在策略，则可以删除或替换对象。
  * 如果存在策略，则只有在对象的期限大于策略时，才能删除或替换对象。
* 锁定保留策略以将其永久设置在存储桶上。
  * 设置后，无法删除或缩短保留期限。
  * 除非存储桶中的每个对象都达到保留期，否则无法删除存储桶。
  * 可以延长锁定对象的保留期限。
  * 锁定保留策略有助于满足数据合规性法规。

### 统一控制对 Cloud Storage 资源的访问


## 使用云存储的最佳实践（第 2 部分）

## 应用程序开发 - 在云存储中存储图像和视频文件

## 练习测验：云存储的最佳实践

## 最终测验：云存储的最佳实践

## 模块复习