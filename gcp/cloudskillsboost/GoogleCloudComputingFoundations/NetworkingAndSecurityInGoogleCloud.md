# 课程信息
## 目标
* 演示如何在云中构建安全网络。
* 识别云自动化和管理工具。

# 课程介绍
略

# 它有助于网络
## 介绍
欢迎来到 Google 云计算基础课程的第七个模块：它有助于网络。  
在本课程的这一部分中，您将了解 Google Cloud 中的网络工作原理以及设置网络之前必须考虑的事项。  
这意味着您将：
* 探索虚拟私有云 (VPC)。
* 检查 Google 的网络架构。
* 了解如何使用多个 VPC 网络。
* 探索构建混合云的选项。
* 检查负载平衡选项。

模块议程遵循目标:
* 首先介绍云中的网络。
* 接下来，您将了解什么是虚拟私有云，包括公共和内部 IP 地址以及 Google 网络架构的基础知识。
* 接下来，您将探索路由和防火墙规则如何在云中工作。
* 之后，您将研究如何使用多个 VPC 网络。
* 两个实验室提供支持：
  * 在第一个中，您将创建 VPC 网络和 VM 实例。
  * 在另一个中，您将创建 Web 服务器并探索 IAM 角色和服务帐户。

## 云中的网络
![谷歌网络如何工作](../images/hwo-google-networking-work.png)  
* Web 客户端或最终用户执行由 Cloud DNS (Cloud Domain Name System)提供服务的域名系统查找。
* 内容分发网络 CDN (Content Delivery Network) 是 Google 网络内的位置，用于缓存更靠近用户的内容，以提高应用程序性能。
* Cloud Load Balancing 将选择合适的前端服务器来处理请求，并将页面返回给用户。
* 在 Google Cloud 中，“网络”是保存网络配置的隔离的全局资源。

## 虚拟私有云 (VPC)
虚拟私有云 (VPC) 是托管在公共云（如 Google Cloud！）内的安全、独立的私有云计算模型。  
VPC 网络将 Google Cloud 资源相互连接并连接到互联网。这包括诸如分段网络、使用防火墙规则限制对实例的访问以及创建静态路由以将流量转发到特定目的地等任务。  
可以在全球任何 Google Cloud 区域拥有子网，这是较大网络的分段部分。子网可以跨越组成地区的区域。  
Google Cloud 提供两种类型的 VPC 网络，具体取决于其子网创建模式：自动子网模式和自定义子网模式。  

## 公共和内部 IP 地址的基础知识
虚拟私有云 (VPC) 由子网组成，每个子网必须配置一个私有 IP CIDR (无类别域间路由) 地址。  
内部IP地址仅用于VPC内的通信，不能路由到Internet。  
那么，公共IP地址和内部IP地址有什么区别呢？  
* 公共或外部 IP 地址可以是临时的或保留的。
* 私有或内部 IP 地址是通过动态主机配置协议 (DHCP) 服务分配给虚拟机的。

## Google 的网络架构
Google Cloud VPC 有 Google 一套全面的网络功能和基础设施：
* Google Cloud VPC 是由 Google 管理的一套全面的网络功能和基础设施。
* Cloud Load Balancing 为 Google Cloud 提供高性能、可扩展的负载均衡，以确保用户获得一致的性能。
* 云 CDN 是一种内容交付网络，通常通过将文件存储在靠近用户的位置，以高可用性和高性能向最终用户提供内容。
* Cloud Interconnect 可让您通过企业级连接将自己的基础设施连接到 Google 的网络边缘。
* Cloud DNS（域名系统）将域名请求转换为 IP 地址。

## 路由以及防火墙规则
与物理网络非常相似，VPC 也有路由表。  
路由表是路由器位置及其 IP 地址的数据表，存储在路由器或网络主机的内存中。它列出了到特定网络目的地的路由，有时还列出了一个度量值（需要到达该地址的“跳数”），这有助于路由器选择最有效的路由。VPC 路由表是内置的，因此您无需配置或管理路由器。它们用于将流量从同一网络内、跨子网甚至 GCP 区域之间的一个实例转发到另一个实例，而无需外部 IP 地址。

---

您无需为 Google Cloud 配置或管理的另一件事是防火墙。  
VPC 提供全球分布式防火墙，可以控制该防火墙以限制通过传入和传出流量对实例的访问。通过 Compute Engine 实例上的元数据标签可以方便地定义防火墙规则。

## 多个 VPC 构建强大的网络
通过 VPC 对等 (VPC peering)，可以在两个 VPC 之间建立关系以交换流量。  
它允许跨两个 VPC 网络进行私有 RFC 1918 连接，无论它们是否属于同一项目或组织。  

---

或者，要使用身份和访问管理 (IAM) 的全部功能来控制一个项目中的人员和内容可以与另一个项目中的 VPC 进行交互，您可以配置共享 VPC (Shared VPC)。  
共享 VPC 允许组织将多个项目的资源连接到公共 VPC 网络。  
使用共享 VPC 时，您可以将一个项目指定为宿主项目，并将一个或多个其他服务项目附加到该项目。

## 实验室简介：多个 VPC 网络
您将创建多个 VPC 网络和虚拟机实例，然后测试跨网络的连接。  
在本实验中，您将：
* 创建具有防火墙规则的自定义模式 VPC 网络。
* 使用 Compute Engine 创建虚拟机实例。
* 探索跨 VPC 网络的虚拟机实例的连接性。
* 创建具有多个网络接口的虚拟机实例。

## 多个 VPC 网络 (GSP211)
### 概览
具体来说，您将创建两个具有防火墙规则和虚拟机实例的自定义模式网络（managementnet 和 privatenet），如下面的网络图所示：
![网络图](../images/GSP211-001.png)

### 目标
在本实验中，您将学习如何执行以下任务：
* 创建具有防火墙规则的自定义模式 VPC 网络
* 使用 Compute Engine 创建虚拟机实例
* 探索各 VPC 网络中虚拟机实例的连接情况
* 创建具有多个网络接口的虚拟机实例

### 设置和要求
略

### 任务 1. 创建具有防火墙规则的自定义模式 VPC 网络
创建两个自定义网络：managementnet 和 privatenet，以及允许 SSH、ICMP 和 RDP 入站流量的防火墙规则。

### 任务 2. 创建虚拟机实例
创建两个虚拟机实例：
* managementsubnet-us 中的 managementnet-us-vm
* privatesubnet-us 中的 privatenet-us-vm

### 任务 3. 探索虚拟机实例之间的连接情况
探索虚拟机实例之间的连接情况。具体来说，对比虚拟机实例位于同一可用区与位于同一 VPC 网络中的效果。  
* Ping 外部 IP 地址：您可以 ping 通所有虚拟机实例的外部 IP 地址，即使它们位于其他可用区或 VPC 网络中也是如此。这就证明了对这些实例的公共访问权限仅由您先前建立的 ICMP 防火墙规则控制。
* Ping 内部 IP 地址：您无法 ping 通 managementnet-us-vm 和 privatenet-us-vm 的内部 IP 地址，因为它们与 ping 操作的来源 (mynet-us-vm) 位于不同的 VPC 网络中，尽管它们位于同一可用区 (us-east1) 中。

### 任务 4. 创建具有多个网络接口的虚拟机实例
创建具有多个网络接口的虚拟机实例：  
创建在 privatesubnet-us、managementsubnet-us 和 mynetwork 中具有网络接口的 vm-appliance 实例。这些子网的 CIDR 范围不重叠，在创建具有多个网络接口控制器 (NIC) 的虚拟机时，必须满足此项要求。

---

探索网络接口详情：  
每个网络接口都有自己的内部 IP 地址，如此虚拟机实例便可与这些网络通信。

---

探索网络接口的连接情况：  
* 您可以使用 privatenet-us-vm 的名称 ping 通此实例，因为 VPC 网络具有内部 DNS 服务，允许您按 DNS 名称（而非内部 IP 地址）对实例进行寻址。如果内部 DNS 查询由实例主机名构成，则会解析为实例的主要接口 (nic0)。因此，在本例中，这仅适用于 privatenet-us-vm。
* 在具有多个接口的实例中，每个接口对于其所在子网都有一个路由。此外，该实例会有一个与主要接口 eth0 相关联的默认路由。除非手动配置，否则从某个实例流向任何目的地（直接关联的子网除外）的所有流量都将通过 eth0 上的默认路由传出该实例。

### 恭喜！
略

## 实验室简介：VPC 网络 - 控制访问
您将创建 NGINX Web 服务器，使用标记的防火墙规则控制对 Web 服务器的外部 HTTP 访问，并探索 IAM 角色和服务账户。  
在本实验中，您将：
* 创建 NGINX Web 服务器。
* 创建标记的防火墙规则。
* 创建具有 IAM 角色的服务账户。
* 探索网络管理员和安全管理员角色的权限。

## VPC 网络 - 控制访问 (GSP213)
### 概述
略

### 设置和要求
略

### 任务 1. 创建 Web 服务器
* 网络使用网络标签来识别哪些虚拟机实例受某些防火墙规则和网络路由的约束。

### 任务 2. 创建防火墙规则
* default-allow-internal 防火墙规则允许默认网络内所有协议/端口上的流量。

### 任务 3. 探索网络和安全管理员角色
* 网络管理员 (Network Admin)：创建、修改和删除网络资源的权限，防火墙规则和 SSL 证书除外。
* 安全管理员 (Security Admin)：创建、修改和删除防火墙规则和 SSL 证书的权限。\

### 恭喜！

## 构建混合云网络
许多 Google Cloud 客户希望将其 Google Virtual Private Cloud 连接到系统中的其他网络，例如本地网络或其他云中的网络。  
有几种有效的方法可以实现这一目标：
![Google VPNs](../images/Google-VPNS.png)
* Cloud VPN 通过 IPsec VPN 连接，将您的对等网络安全地连接到 Virtual Private Cloud (VPC) 网络。两个网络之间传输的流量由一个 VPN 网关加密，再由另一个 VPN 网关解密。此操作可以保护您的数据在互联网上传输时的安全。您还可以将两个 Cloud VPN 实例相互连接。
  * Internet Protocol Security: IPsec是一种强大的网络安全协议，用于确保在互联网上进行的数据传输的机密性、完整性和认证性。它在保护敏感数据和构建安全连接方面发挥着重要作用。
  * VPN（Virtual Private Network，虚拟私有网络）：是一种用于在公共网络（如互联网）上建立加密隧道的技术，用于在远程位置之间创建安全的通信连接。通过VPN，用户可以在不受地理位置限制的情况下，安全地访问远程网络资源，就像直接连接到私有网络一样。
* 借助直接对等互连 (Direct Peering)，您能够在企业网络和 Google 边缘网络之间建立直接对等互连连接，并交换高吞吐量的云端流量。建立直接对等互连以后，可以为您的本地网络到 Google 服务（包括可通过一个或多个公共 IP 地址公开的 Google Cloud 产品）提供直接通道。从 Google 网络到您的本地网络的流量（包括来自您的项目中 VPC 网络的流量）也会经由该直接通道。
* 借助运营商对等互连 (Carrier Peering)，您可以通过服务提供商访问 Google 应用（例如 Google Workspace），以获取将您的基础架构连接到 Google 的企业级网络服务。通过服务提供商连接到 Google 时，您可以使用一条或多条链路获得具有更高可用性、更短延迟时间的连接。与服务提供商合作，获取您所需的连接。
* 合作伙伴互连通 (Partner Interconnect) 过支持的服务提供商在本地网络与 Virtual Private Cloud (VPC) 网络之间提供连接。如果您的数据中心所在的物理位置无法连接到专用互连对接网点，或者如果您的数据不需要用尽 10 Gbps 的连接，则合作伙伴互连连接很有用。  ![合作伙伴互连通](../images/partner-interconnect.png)
* 专用互连 (Dedicated Interconnect) 可在您的本地网络和 Google 网络之间提供直接物理连接。通过专用互连，您可以在网络之间传输大量数据，这比在公共互联网上购买额外带宽更加经济实惠。  ![专用互连](../images/single-interconnect.png)

## 负载平衡选项
负载均衡器的工作是在应用程序的多个实例之间分配用户流量。  
Cloud Load Balancing 是一项完全分布式、软件定义的托管服务，适用于您的所有流量。而且由于负载均衡器不在您必须管理的虚拟机中运行，因此您不必担心扩展或管理它们。您可以将 Cloud Load Balancing 置于所有流量之前：HTTP(S)、TCP 流量 和 SSL 流量以及 UDP 流量。Cloud Load Balancing 提供跨区域负载平衡，包括自动多区域故障转移，如果后端变得不健康，它会缓慢地分批转移流量。Cloud Load Balancing 可对用户、流量、网络、后端运行状况和其他相关条件的变化做出快速反应。  ![负载平衡选项](../images/load-balancing-options.png)  
Cloud VPC 提供了一套负载均衡选项：
* 如果您需要对 Web 应用程序进行跨区域负载均衡，请使用全局 HTTP(S) 负载均衡。
* 对于非 HTTP 的安全套接字层 (SSL) 流量，请使用 SSL 代理负载平衡。
* 如果是其他不使用安全套接字层的 TCP 流量，请使用 TCP 代理负载平衡。
* 如果您想要对 UDP 流量或任何端口号上的流量进行负载平衡，您仍然可以通过区域外部负载平衡 (Regional external load balancing) 在整个 Google Cloud 区域中实现负载平衡。
* 如果您想在项目内部（例如应用程序的表示层和业务层之间）对流量进行负载平衡，请使用内部 HTTP(S) 负载平衡。

## 实验室简介：使用 Google Cloud Armor 的 HTTP 负载均衡器
您将使用 Google Cloud Armor 配置 HTTP 负载均衡器。  
Google Cloud Armor 用于帮助缓解分布式拒绝服务 (DDoS) 攻击。  
您将配置具有全局后端的 HTTP 负载均衡器，并对负载均衡器进行压力测试，并使用 Google Cloud Armor 将压力测试 IP 列入黑名单。  
在本实验中，您将：
* 创建 HTTP 和运行状况检查防火墙规则。
* 配置两个实例模板。
* 创建两个托管实例组。
* 使用 IPv4 和 IPv6 配置 HTTP 负载均衡器。
* 对 HTTP 负载均衡器进行压力测试。
* 将 IP 地址列入黑名单以限制对 HTTP 负载均衡器的访问。

## 具有 Cloud Armor 的 HTTP 负载均衡器 (GSP215)
### 概述
Google Cloud HTTP(S) 负载平衡是在 Google 网络边缘、Google 遍布全球的接入点 (POP) 中实现的。定向到 HTTP(S) 负载平衡器的用户流量进入距离用户最近的 POP，然后通过 Google 的全球网络进行负载平衡，到达具有足够可用容量的最近后端。

Cloud Armor IP 允许列表/拒绝列表使您能够限制或允许访问位于 Google Cloud 边缘的 HTTP(S) 负载均衡器，尽可能靠近用户和恶意流量。这可以防止恶意用户或流量消耗资源或进入您的虚拟私有云 (VPC) 网络。

在本实验中，您将配置具有全局后端的 HTTP 负载均衡器，如下图所示。然后，您对负载均衡器进行压力测试，并使用 Cloud Armor 将压力测试 IP 列入拒绝名单。  ![图](../images/http-load-balancer-with-cloud-armor.png)

### 设置和要求

### 任务 1. 配置 HTTP 和运行状况检查防火墙规则
### 任务 2. 配置实例模板并创建实例组
### 任务 3. 配置 HTTP 负载均衡器
### 任务 4. 测试 HTTP 负载均衡器
### 任务 5. 将 siege-vm 列入拒绝名单
### 恭喜！