
# 实验室简介：实施私有 Google 访问和 Cloud NAT
在本实验中，您将为没有外部 IP 地址的虚拟机实例实施私有 Google 访问和 Cloud NAT。然后，您验证对 Google API 和服务的公共 IP 地址以及其他互联网连接的访问​​。

# [概览](https://www.cloudskillsboost.google/course_sessions/4481651/labs/393770)
在此实验中，您将为不具备外部 IP 地址的虚拟机实例实现专用 Google 访问通道和 Cloud NAT。然后，您将验证能否访问 Google API 和服务的公共 IP 地址以及进行其他互联网连接。

不具备外部 IP 地址的虚拟机实例与外部网络是隔离开来的。通过使用 Cloud NAT，这些实例可以访问互联网，以进行更新和修补，在某些情况下，还可以进行引导。作为一项代管式服务，Cloud NAT 无需用户管理和干预即可实现高可用性。

# 目标
在本实验中，您将学习如何执行以下任务：
* 配置不具备外部 IP 地址的虚拟机实例
* 使用 Identity-Aware Proxy (IAP) 隧道连接至虚拟机实例
* 在子网中启用专用 Google 访问通道
* 配置 Cloud NAT 网关
* 验证能否访问 Google API 和服务的公共 IP 地址以及进行其他互联网连接

# 任务 1. 创建虚拟机实例
IAP 连接来自一组特定的 IP 地址 (35.235.240.0/20)。因此，您可以将规则限制为此 CIDR 范围。  
虚拟机实例默认设置为有一个临时的外部 IP 地址。可在组织或项目级施加政策限制来更改这一行为。  
如果实例不具备外部 IP 地址，那么只有网络中的其他实例可通过代管式 VPN 网关或 Cloud IAP 隧道访问它们。Cloud IAP 无需堡垒主机，即可通过 SSH 和 RDP 实现对虚拟机的情境感知访问权限。

# 任务 2. 启用专用 Google 访问通道
不具备外部 IP 地址的虚拟机实例可通过专用 Google 访问通道来访问 Google API 和服务的外部 IP 地址。默认情况下，VPC 网络的专用 Google 访问通道处于停用状态。

# 任务 3. 配置 Cloud NAT 网关
虽然 vm-internal 现在无需外部 IP 地址，即可访问特定的 Google API 和服务，但该实例无法访问互联网以进行更新和修补。您可以配置 Cloud NAT 网关，以便 vm-internal 能够访问互联网。  
Cloud NAT 是一种区域级资源。您可以将其配置为允许来自一个区域中所有子网的所有范围的流量、仅允许来自该区域中特定子网的流量，或者仅允许来自于特定主要和次要 CIDR 范围的流量。  
Cloud NAT 网关可实现出站 NAT，但无法实现入站 NAT。换句话说，VPC 网络外部的主机只能响应由您的实例发起的连接；它们自身无法通过 NAT 发起与您的实例的新连接。

# 任务 4. 使用 Cloud NAT 日志记录功能配置并查看日志
Cloud NAT 日志记录功能可让您记录 NAT 连接和错误。启用 Cloud NAT 日志记录功能后，系统可针对以下情景各生成一个日志条目：
* 创建好使用 NAT 的网络连接时。
* 数据包因没有可用于 NAT 的端口而被丢弃时。

您可以选择同时记录这两种事件，也可以只记录其中一种。创建的日志会发送至 Cloud Logging。

# 任务 5. 回顾
当您连接到虚拟机实例时，IAP 将使用您的现有项目角色和权限。默认情况下，实例所有者是唯一具有 IAP Secured Tunnel User 角色的用户。
