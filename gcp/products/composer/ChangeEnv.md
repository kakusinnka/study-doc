# 更新, 升级和删除环境
## 更新环境
### 关于更新操作
对于单个 Cloud Composer 环境，一次只能启动一项更新操作。您必须等待更新操作完成后才能开始其他环境操作。
### 关于使用 Terraform 进行更新
不了解 Terraform
### 查看环境详情
### 更新环境

## 升级环境
### 关于升级操作
当您更改环境使用的 Airflow 或 Cloud Composer 版本时，您的环境会升级。
### 准备工作
### 检查您的环境是否为最新版本
当您的环境映像接近支持终止日期时，Cloud Composer 会显示警告。您可以根据这些警告，确保您的环境始终在完整的支持期内。
### 查看可用升级
### 在升级之前检查是否存在 PyPI 软件包冲突
### 升级您的环境

## 删除环境
### 准备工作
* 未自动删除的资源
* 您的环境的集群已自动删除
### 删除 Cloud Composer 环境
1. 删除 Cloud Composer 环境
2. 删除环境的存储桶。

## 保存和加载环境快照
### 环境快照简介
环境快照会存储您的环境的状态。您可以根据需要保存和加载环境快照。
* 快照的存储方式: 环境快照是一组文件，用于描述环境的状态并存储环境数据的备份。
* 快照的安全注意事项: 为了缓解此安全风险，您可以将 Airflow DAG 使用的敏感信息（如密钥或密码）存储在 Secret Manager 中。
* 快照中会保存哪些数据: ...
* 从快照加载哪些数据: ...
* 关于部分完成的操作: 对于部分完成的操作，您可以尝试重新加载相同的快照。Cloud Composer 会跳过在上一次尝试中成功完成的步骤。
### 准备工作
* 快照不会创建环境。如果要将环境中的快照加载到其他环境，首先需要创建新环境，然后将快照加载到该环境中。
* 您无法将快照加载到处于错误状态的环境。
* 您只能将快照加载到相同或更高版本的 Cloud Composer 或 Airflow 中。
* 快照不会更改 Cloud Composer 版本。
* 支持快照的 Airflow 数据库的大小上限为 20 GB。
### 保存环境快照
### 加载环境快照
加载快照后，DAG 运行历史记录会恢复到快照的状态。这可能会导致重复的 DAG 运行。

## 配置计划快照
### 计划快照的工作原理
启用计划快照后，Cloud Composer 会定期将您的环境快照保存到 Cloud Storage 存储桶。
### 准备工作
### 为计划快照创建存储桶
* 配置存储桶的权限
* 存储桶设置生命周期配置: 为了节省存储费用，您可以配置规则，以在一段时间后删除环境快照。
### 为您的环境启用快照时间表
### 停用计划快照

## 使用环境快照进行灾难恢复
### 定义
### 灾难恢复过程简介
### 准备工作
### 准备工作概览
### 灾难恢复概览
### 准备步骤
* 创建故障切换环境
* 检查资源可用性
* 为快照创建存储桶
* 设置数据库维护
* 设置计划快照
* （可选）为计划快照操作设置监控
* 测试灾难恢复过程
### 灾难发生后
* 停止主环境执行 DAG
* 将快照加载到故障切换环境
* （如果需要）调整故障切换环境的配置
### 确定如何处理主要环境
* 如果主要环境存在，但无法正常运行
* 如果主要环境恢复正常且可访问

## 清理 Airflow 数据库
### 运行 Airflow 数据库维护 DAG
您可以使用以下维护 DAG 来清理数据库的内容。此 DAG 会从 DagRun、TaskInstance、Log、XCom、Job DB 和 SlaMiss 表中移除旧条目。
### 移除未使用的 DAG 的条目
