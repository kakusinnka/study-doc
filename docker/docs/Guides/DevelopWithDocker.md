# 使用 Docker 开发

## 概述
此页面包含适用于希望使用 Docker 构建新应用程序的应用程序开发人员的资源列表。

## Docker 开发最佳实践
### 如何让你的镜像变小
* 从合适的基础镜像开始。
* 使用多阶段构建。
* 如果您有多个具有很多共同点的图像，请考虑使用共享组件创建您自己的 基础图像，并以此为基础创建您独特的图像。
* 要保持生产映像精简但允许调试，请考虑使用生产映像作为调试映像的基础映像。
* 构建镜像时，始终使用有用的标签来标记它们
### 在哪里以及如何保存应用程序数据
* 避免将应用程序数据存储在容器的可写层中。
* 使用卷存储数据。
* 一种适合使用绑定挂载的情况是在开发期间，当您可能想要挂载源目录或刚刚构建到容器中的二进制文件时。对于生产，请改用卷。
* 对于生产环境，使用 secrets 存储服务使用的敏感应用程序数据，使用 configs 存储配置文件等非敏感数据。
### 使用 CI/CD 进行测试和部署
### 开发环境和生产环境的差异
| 开发环境 | 生产环境 |
| ---- | ---- |
| 使用绑定安装让您的容器可以访问您的源代码。 | 使用卷来存储容器数据。 |
|  使用 Docker Desktop | 使用 Docker 引擎，如果可能的话，使用用户映射来更好地隔离 Docker 进程与主机进程。 |
| 不用担心时间漂移。 | 始终在 Docker 主机上和每个容器进程中运行 NTP 客户端，并将它们全部同步到同一 NTP 服务器。如果您使用 swarm 服务，还要确保每个 Docker 节点将其时钟同步到与容器相同的时间源。 |

## 编写 Dockerfile 的最佳实践
编写 Dockerfile 的最佳实践, Docker 通过读取 Dockerfile 中的指令自动构建镜像, 一个文本文件，其中按顺序包含构建给定镜像所需的所有命令。
### 一般准则和建议
* 创建临时容器
* 了解构建上下文
* 通过标准输入代表 Dockerfile
  ```
  echo -e 'FROM busybox\nRUN echo "hello world"' | docker build -
  ```
  ```
  docker build -<<EOF
  FROM busybox
  RUN echo "hello world"
  EOF
  ```
* 使用来自标准输入的 Dockerfile 构建图像，而不发送构建上下文
* 使用来自标准输入的 Dockerfile 从本地上下文构建
* 使用来自标准输入的 Dockerfile 从远程上下文构建
* 使用 .dockerignore 排除
* 使用多阶段构建: 多阶段构建允许您大幅减小最终图像的大小，而无需努力减少中间层和文件的数量。
* 不要安装不必要的包
* 解耦应用程序: 每个容器应该只有一个问题。将每个容器限制为一个进程是一个很好的经验法则，但这不是一个硬性规定。
* 尽量减少层数
* 对多行参数进行排序
* 利用构建缓存
### Dockerfile 说明
* FROM: 用于指定基础镜像
* LABEL: 用于为镜像添加元数据信息，包括镜像的版本号、维护者信息、描述等。
* RUN: 指令用于在镜像构建过程中运行命令，并将其结果保存到镜像中。
  * apt-get: 使用RUN apt-get update && apt-get install -y可确保您的 Dockerfile 安装最新的软件包版本，而无需进一步编码或手动干预。这种技术称为缓存破坏。您还可以通过指定包版本来实现缓存清除。这称为版本固定。
  * Using pipes: 使用管道字符 ( | ) 将一个命令的输出传输到另一个命令。
* CMD: 用于指定容器启动时要运行的默认命令。
* EXPOSE: 指示容器侦听连接的端口。
* ENV: 用于设置 Docker 容器内的环境变量，可以通过 $VAR_NAME 来引用这些环境变量。使用 --build-arg 参数可以在构建镜像时传递环境变量。
* ADD, COPY: ADD 和 COPY 指令都可以用于将文件从构建环境复制到容器内部。ADD 指令可以自动解压缩文件和下载远程资源，但是建议在可能的情况下使用 COPY 指令来复制本地文件。
* ENTRYPOINT: 定义容器启动时要执行的命令。
* VOLUME: 用于在容器中创建一个挂载点，并指示 Docker 运行时在这个挂载点上创建一个数据卷。数据卷是 Docker 中一个非常重要的概念，它可以让容器和宿主机之间共享数据，并且保证在容器被删除后数据依然存在。
* USER: 用于指定在容器中运行时使用的用户或用户组，可以为 Docker 容器中运行的应用程序提供一个非特权的用户身份，从而增强容器的安全性。
* WORKDIR: 指令用于设置容器中的工作目录，可以方便地切换容器中的工作目录。在执行后续的 Dockerfile 指令时，将在该目录下执行。可以出现多次，每次出现将会修改工作目录。
* ONBUILD: 指令用于定义一组指令，这些指令将在本 Dockerfile 所构建的镜像被其他 Dockerfile 中的 FROM 指令作为基础镜像时被执行，可以方便地为镜像添加触发器，并在构建过程中自动触发。

## 安全最佳实践
### 选择合适的基础镜像
* 选择图像时，请确保它是从可信来源构建的并保持较小。
* 选择基本图像时，请注意官方图像和已验证发布者徽章。
* 您还应该考虑使用两种类型的基础映像：第一种用于开发和单元测试，第二种用于在开发和生产的最新阶段进行测试。
### 使用多阶段构建
通过多阶段构建，您可以使用多个图像并有选择地仅从特定图像复制所需的工件。
### 重建图像
* 每个容器应该只有一个职责。
* 容器应该是不可变的、轻量级的和快速的。
* 不要将数据存储在容器中。 请改用共享数据存储。
* 容器应该易于销毁和重建。
* 使用小型基础映像（例如 Linux Alpine）。 较小的图像更容易分发。
* 避免安装不必要的包。 这样可以保持图像清洁和安全。
* 构建时避免缓存命中。
* 在部署之前自动扫描您的图像，以避免将易受攻击的容器推向生产环境。
* 在开发和生产期间每天分析您的图像是否存在漏洞。 在此基础上，如有必要，自动重建图像。
### 检查您的图像是否存在漏洞
除了在开发图像时遵循本页概述的最佳实践外，使用漏洞检测工具持续分析和评估图像的安全状况也很重要。
### 结论
* 从您信任的基础映像开始。 选择基本图像时，请注意官方图像和已验证发布者徽章。
* 保护您的代码及其依赖项。
* 选择仅包含所需包的最小基础映像。
* 使用多阶段构建来优化您的图像。
* 确保仔细监控和管理添加到映像中的工具和依赖项。
* 确保在开发生命周期的多个阶段扫描图像。
* 经常检查您的图像是否存在漏洞。

## 使用 Kubernetes 进行远程开发
开发大型云原生应用程序的团队可能会发现自己无法在开发机器上本地运行整个应用程序。
### 结合本地和远程
这个问题的一种解决方案是将本地服务与远程开发集群集成。
### Telepresence
Telepresence 是一个开源 CNCF 项目，可帮助您将本地服务与远程 Kubernetes 集群集成。
### Docker × Ambassador
